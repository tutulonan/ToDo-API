<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToDo API Frontend</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1, h2, h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background-color: #2980b9;
        }

        button.danger {
            background-color: #e74c3c;
        }

        button.danger:hover {
            background-color: #c0392b;
        }

        button.success {
            background-color: #2ecc71;
        }

        button.success:hover {
            background-color: #27ae60;
        }

        button.warning {
            background-color: #f39c12;
        }

        button.warning:hover {
            background-color: #d68910;
        }

        .buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        #status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }

        #status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        #status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        #status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }

        .task {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
        }

        .task h4 {
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .task p {
            color: #666;
            margin-bottom: 10px;
        }

        .task-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 10px;
        }

        .task-actions {
            margin-top: 10px;
        }

        .task.done {
            opacity: 0.7;
            background-color: #f8f9fa;
        }

        .task.done h4 {
            text-decoration: line-through;
            color: #95a5a6;
        }

        .priority {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 5px;
        }

        .priority-1 { background-color: #e74c3c; color: white; }
        .priority-2 { background-color: #e67e22; color: white; }
        .priority-3 { background-color: #f1c40f; color: #333; }
        .priority-4 { background-color: #2ecc71; color: white; }
        .priority-5 { background-color: #3498db; color: white; }

        .source {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 5px;
        }

        .source-manual { background-color: #9b59b6; color: white; }
        .source-hacker_news { background-color: #34495e; color: white; }

        #ws-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }

        #ws-status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        #ws-status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .logs {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid #34495e;
        }

        .log-time {
            color: #95a5a6;
        }

        .log-type {
            font-weight: bold;
            margin: 0 5px;
        }

        .log-type.ws { color: #3498db; }
        .log-type.api { color: #2ecc71; }
        .log-type.error { color: #e74c3c; }
    </style>
</head>
<body>
    <h1>üìù ToDo API Frontend</h1>
    <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏ —Å WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏</p>

    <div id="status"></div>

    <div class="container">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div>
            <!-- –°–µ–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è WebSocket -->
            <div class="section">
                <h2>üîó WebSocket Connection</h2>
                <div id="ws-status" class="disconnected">–û—Ç–∫–ª—é—á–µ–Ω–æ</div>
                <div class="buttons">
                    <button id="ws-connect" class="success">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
                    <button id="ws-disconnect" class="danger">–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
                    <button id="ws-test" class="warning">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
                </div>
                <h3>WebSocket –õ–æ–≥–∏:</h3>
                <div id="ws-logs" class="logs"></div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
            <div class="section">
                <h2>‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</h2>
                <div class="form-group">
                    <label for="title">–ó–∞–≥–æ–ª–æ–≤–æ–∫:</label>
                    <input type="text" id="title" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞—á–∏">
                </div>
                <div class="form-group">
                    <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <textarea id="description" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏"></textarea>
                </div>
                <div class="form-group">
                    <label for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                    <select id="category">
                        <option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                        <option value="work">–†–∞–±–æ—Ç–∞</option>
                        <option value="personal">–õ–∏—á–Ω–æ–µ</option>
                        <option value="study">–£—á–µ–±–∞</option>
                        <option value="hacker_news">Hacker News</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="priority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</label>
                    <select id="priority">
                        <option value="1">1 - –ù–∏–∑–∫–∏–π</option>
                        <option value="2">2</option>
                        <option value="3" selected>3 - –°—Ä–µ–¥–Ω–∏–π</option>
                        <option value="4">4</option>
                        <option value="5">5 - –í—ã—Å–æ–∫–∏–π</option>
                    </select>
                </div>
                <div class="buttons">
                    <button id="create-task" class="success">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
                </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–æ–Ω–æ–≤—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏ -->
            <div class="section">
                <h2>‚öôÔ∏è –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏</h2>
                <p>–ü–∞—Ä—Å–∏–Ω–≥ Hacker News</p>
                <div class="buttons">
                    <button id="run-background-task" class="success">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ–π—á–∞—Å</button>
                    <button id="get-background-status" class="warning">–°—Ç–∞—Ç—É—Å —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏</button>
                    <button id="get-hn-stats" class="warning">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Hacker News</button>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div>
            <!-- –°–µ–∫—Ü–∏—è —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á -->
            <div class="section">
                <h2>üìã –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á</h2>
                <div class="buttons">
                    <button id="get-tasks" class="success">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                    <button id="get-tasks-done" class="warning">–¢–æ–ª—å–∫–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
                    <button id="get-tasks-pending" class="warning">–¢–æ–ª—å–∫–æ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
                    <select id="task-filter" style="padding: 8px; margin-left: 10px;">
                        <option value="all">–í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏</option>
                        <option value="manual">–†—É—á–Ω—ã–µ</option>
                        <option value="hacker_news">Hacker News</option>
                    </select>
                </div>
                <div id="tasks-container" style="margin-top: 20px;"></div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
            <div class="section">
                <h2>‚úèÔ∏è –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É</h2>
                <div class="form-group">
                    <label for="update-id">ID –∑–∞–¥–∞—á–∏:</label>
                    <input type="number" id="update-id" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∑–∞–¥–∞—á–∏">
                </div>
                <div class="form-group">
                    <label for="update-title">–ù–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫:</label>
                    <input type="text" id="update-title" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫">
                </div>
                <div class="form-group">
                    <label for="update-description">–ù–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <textarea id="update-description" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"></textarea>
                </div>
                <div class="form-group">
                    <label for="update-done">
                        <input type="checkbox" id="update-done"> –í—ã–ø–æ–ª–Ω–µ–Ω–æ
                    </label>
                </div>
                <div class="buttons">
                    <button id="update-task" class="warning">–û–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
                    <button id="delete-task" class="danger">–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É</button>
                </div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è API –∑–∞–ø—Ä–æ—Å–æ–≤ -->
            <div class="section">
                <h2>üîß API –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
                <div class="buttons">
                    <button id="get-task-by-id" class="warning">–ü–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞—á—É –ø–æ ID</button>
                    <button id="test-add" class="success">–¢–µ—Å—Ç —Å–ª–æ–∂–µ–Ω–∏—è (2+3)</button>
                    <button id="test-health" class="warning">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è</button>
                </div>
                <h3>API –õ–æ–≥–∏:</h3>
                <div id="api-logs" class="logs"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        let ws = null;

        // ========== –£–¢–ò–õ–ò–¢–´ ==========
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = type;
            setTimeout(() => {
                statusEl.className = '';
                statusEl.style.display = 'none';
            }, 5000);
        }

        function addLog(logType, message) {
            const logEl = document.getElementById(`${logType}-logs`);
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-type ${logType}">${logType.toUpperCase()}</span> ${message}`;
            logEl.appendChild(logEntry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        // ========== WEBSOCKET ==========
        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                showStatus('WebSocket —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω', 'info');
                return;
            }

            ws = new WebSocket('ws://localhost:8000/ws/tasks');

            ws.onopen = () => {
                document.getElementById('ws-status').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                document.getElementById('ws-status').className = 'connected';
                showStatus('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω', 'success');
                addLog('ws', '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    addLog('ws', `üì® ${data.type}: ${data.message}`);

                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –ø—Ä–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö
                    if (data.type.includes('task_')) {
                        getTasks();
                    }
                } catch (e) {
                    addLog('ws', `üì® ${event.data}`);
                }
            };

            ws.onclose = () => {
                document.getElementById('ws-status').textContent = '–û—Ç–∫–ª—é—á–µ–Ω–æ';
                document.getElementById('ws-status').className = 'disconnected';
                addLog('ws', '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
            };

            ws.onerror = (error) => {
                addLog('error', `WebSocket –æ—à–∏–±–∫–∞: ${error}`);
            };
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // ========== API –ó–ê–ü–†–û–°–´ ==========
        async function apiRequest(method, endpoint, data = null) {
            const url = `${API_BASE_URL}${endpoint}`;
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                },
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                addLog('api', `${method} ${endpoint}`);
                const response = await fetch(url, options);
                const responseData = await response.json();

                if (!response.ok) {
                    throw new Error(responseData.detail || `HTTP ${response.status}`);
                }

                return responseData;
            } catch (error) {
                addLog('error', `–û—à–∏–±–∫–∞ ${method} ${endpoint}: ${error.message}`);
                throw error;
            }
        }

        // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –î–õ–Ø –ó–ê–î–ê–ß ==========
        async function getTasks(filter = 'all', done = null) {
            try {
                let endpoint = '/tasks';
                const params = [];

                if (done !== null) {
                    params.push(`done=${done}`);
                }

                if (filter !== 'all') {
                    params.push(`source=${filter}`);
                }

                if (params.length > 0) {
                    endpoint += `?${params.join('&')}`;
                }

                const tasks = await apiRequest('GET', endpoint);
                renderTasks(tasks);
                showStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${tasks.length} –∑–∞–¥–∞—á`, 'success');
            } catch (error) {
                showStatus(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–¥–∞—á: ${error.message}`, 'error');
            }
        }

        function renderTasks(tasks) {
            const container = document.getElementById('tasks-container');

            if (tasks.length === 0) {
                container.innerHTML = '<p>–ó–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }

            container.innerHTML = '';

            tasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = `task ${task.done ? 'done' : ''}`;

                const priorityClass = `priority priority-${task.priority}`;
                const sourceClass = `source source-${task.source}`;

                taskEl.innerHTML = `
                    <h4>${task.title}</h4>
                    <p>${task.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                    <div class="task-info">
                        <div>
                            <span class="${priorityClass}">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${task.priority}</span>
                            <span class="${sourceClass}">${task.source === 'hacker_news' ? 'Hacker News' : '–†—É—á–Ω–∞—è'}</span>
                            ${task.category ? `<span>üìÇ ${task.category}</span>` : ''}
                        </div>
                        <div>ID: ${task.id}</div>
                    </div>
                    <div class="task-actions">
                        <button onclick="markTaskAsDone(${task.id}, ${!task.done})" class="${task.done ? 'warning' : 'success'}">
                            ${task.done ? '‚ùå –û—Ç–º–µ—Ç–∏—Ç—å –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π' : '‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π'}
                        </button>
                        <button onclick="deleteTaskPrompt(${task.id})" class="danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;

                container.appendChild(taskEl);
            });
        }

        async function createTask() {
            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            const category = document.getElementById('category').value;
            const priority = parseInt(document.getElementById('priority').value);

            if (!title) {
                showStatus('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞—á–∏', 'error');
                return;
            }

            try {
                const taskData = {
                    title,
                    description: description || null,
                    category: category || null,
                    priority
                };

                await apiRequest('POST', '/tasks', taskData);

                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('title').value = '';
                document.getElementById('description').value = '';

                showStatus('–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ', 'success');
                getTasks();
            } catch (error) {
                showStatus(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ${error.message}`, 'error');
            }
        }

        async function updateTask() {
            const id = document.getElementById('update-id').value.trim();
            const title = document.getElementById('update-title').value.trim();
            const description = document.getElementById('update-description').value.trim();
            const done = document.getElementById('update-done').checked;

            if (!id) {
                showStatus('–í–≤–µ–¥–∏—Ç–µ ID –∑–∞–¥–∞—á–∏', 'error');
                return;
            }

            const updateData = {};
            if (title) updateData.title = title;
            if (description) updateData.description = description;
            updateData.done = done;

            try {
                await apiRequest('PATCH', `/tasks/${id}`, updateData);

                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('update-id').value = '';
                document.getElementById('update-title').value = '';
                document.getElementById('update-description').value = '';
                document.getElementById('update-done').checked = false;

                showStatus('–ó–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ', 'success');
                getTasks();
            } catch (error) {
                showStatus(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ${error.message}`, 'error');
            }
        }

        async function deleteTask() {
            const id = document.getElementById('update-id').value.trim();

            if (!id) {
                showStatus('–í–≤–µ–¥–∏—Ç–µ ID –∑–∞–¥–∞—á–∏', 'error');
                return;
            }

            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É #${id}?`)) {
                return;
            }

            try {
                await apiRequest('DELETE', `/tasks/${id}`);

                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('update-id').value = '';

                showStatus('–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ', 'success');
                getTasks();
            } catch (error) {
                showStatus(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ${error.message}`, 'error');
            }
        }

        async function markTaskAsDone(taskId, done) {
            try {
                await apiRequest('PATCH', `/tasks/${taskId}`, { done });
                showStatus(`–ó–∞–¥–∞—á–∞ ${done ? '–≤—ã–ø–æ–ª–Ω–µ–Ω–∞' : '–Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞'}`, 'success');
                getTasks();
            } catch (error) {
                showStatus(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ${error.message}`, 'error');
            }
        }

        function deleteTaskPrompt(taskId) {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É #${taskId}?`)) {
                apiRequest('DELETE', `/tasks/${taskId}`)
                    .then(() => {
                        showStatus('–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
                        getTasks();
                    })
                    .catch(error => {
                        showStatus(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ${error.message}`, 'error');
                    });
            }
        }

        // ========== –§–û–ù–û–í–´–ï –ó–ê–î–ê–ß–ò ==========
        async function runBackgroundTask() {
            try {
                await apiRequest('POST', '/task-generator/run');
                showStatus('–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –∑–∞–ø—É—â–µ–Ω–∞', 'success');
            } catch (error) {
                showStatus(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏: ${error.message}`, 'error');
            }
        }

        async function getBackgroundStatus() {
            try {
                const status = await apiRequest('GET', '/background-task/status');
                alert(`–°—Ç–∞—Ç—É—Å —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏:\n\n` +
                      `–ó–∞–ø—É—â–µ–Ω–∞: ${status.running ? '–î–∞' : '–ù–µ—Ç'}\n` +
                      `–°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑: ${status.next_run_in_seconds} —Å–µ–∫—É–Ω–¥\n` +
                      `–û–ø–∏—Å–∞–Ω–∏–µ: ${status.description}\n` +
                      `–ò—Å—Ç–æ—á–Ω–∏–∫: ${status.source}`);
            } catch (error) {
                showStatus(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: ${error.message}`, 'error');
            }
        }

        async function getHackerNewsStats() {
            try {
                const stats = await apiRequest('GET', '/hacker-news/stats');
                alert(`–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Hacker News:\n\n` +
                      `–í—Å–µ–≥–æ –∑–∞–¥–∞—á: ${stats.total_tasks}\n` +
                      `–í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${stats.done_tasks}\n` +
                      `–í –ø—Ä–æ—Ü–µ—Å—Å–µ: ${stats.pending_tasks}\n` +
                      `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º:\n` +
                      Object.entries(stats.priority_stats || {})
                        .map(([priority, count]) => `  –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç ${priority}: ${count} –∑–∞–¥–∞—á`)
                        .join('\n'));
            } catch (error) {
                showStatus(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${error.message}`, 'error');
            }
        }

        // ========== –¢–ï–°–¢–û–í–´–ï –§–£–ù–ö–¶–ò–ò ==========
        async function testAdd() {
            try {
                const result = await apiRequest('GET', '/add?a=2&b=3');
                showStatus(`–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–ª–æ–∂–µ–Ω–∏—è 2+3 = ${result.result}`, 'success');
            } catch (error) {
                showStatus(`–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞ —Å–ª–æ–∂–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        async function testHealth() {
            try {
                const health = await apiRequest('GET', '/health');
                showStatus(`–°—Ç–∞—Ç—É—Å –∑–¥–æ—Ä–æ–≤—å—è: ${health.status}`, 'success');
            } catch (error) {
                showStatus(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è: ${error.message}`, 'error');
            }
        }

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        document.addEventListener('DOMContentLoaded', () => {
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º WebSocket –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            connectWebSocket();

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            getTasks();

            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('ws-connect').addEventListener('click', connectWebSocket);
            document.getElementById('ws-disconnect').addEventListener('click', disconnectWebSocket);
            document.getElementById('ws-test').addEventListener('click', () => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send('–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞');
                    showStatus('–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
                } else {
                    showStatus('WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω', 'error');
                }
            });

            document.getElementById('create-task').addEventListener('click', createTask);
            document.getElementById('update-task').addEventListener('click', updateTask);
            document.getElementById('delete-task').addEventListener('click', deleteTask);

            document.getElementById('get-tasks').addEventListener('click', () => getTasks('all'));
            document.getElementById('get-tasks-done').addEventListener('click', () => getTasks('all', true));
            document.getElementById('get-tasks-pending').addEventListener('click', () => getTasks('all', false));

            document.getElementById('task-filter').addEventListener('change', (e) => {
                getTasks(e.target.value);
            });

            document.getElementById('run-background-task').addEventListener('click', runBackgroundTask);
            document.getElementById('get-background-status').addEventListener('click', getBackgroundStatus);
            document.getElementById('get-hn-stats').addEventListener('click', getHackerNewsStats);

            document.getElementById('test-add').addEventListener('click', testAdd);
            document.getElementById('test-health').addEventListener('click', testHealth);

            // –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –ø–æ Enter
            document.getElementById('title').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') createTask();
            });

            document.getElementById('update-id').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') updateTask();
            });
        });
    </script>
</body>
</html>